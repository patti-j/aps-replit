@page "/ai_analytics"
@attribute [Authorize]
@implements IAsyncDisposable

@inject IUserService m_userService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime js
@inject IEmbedTokenService EmbedTokenService
@inject IAppInsightsLogger logger
@inject IDarkModeService DarkModeService
@inject IConfiguration Configuration

@using ReportsWebApp.Common
@using ReportsWebApp.DB.Models
@using ReportsWebApp.DB.Services.Interfaces
@using ReportsWebApp.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

@if (!hasLoaded)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!hasAccess)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
        <div class="text-center">
            <i class="fa fa-lock fa-3x text-muted mb-3"></i>
            <h4>Access Denied</h4>
            <p class="text-muted">You do not have access to AI Analytics. Please contact your administrator to request the AI Analytics role.</p>
        </div>
    </div>
}
else
{
    <style>
        .ai-analytics-container {
            width: 100%;
            height: calc(100vh - 50px);
            overflow: hidden;
            margin: -1rem -1.5rem;
            width: calc(100% + 3rem);
        }
        .ai-analytics-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
    </style>
    <div class="ai-analytics-container">
        <iframe @ref="iframeRef"
                src="@IframeUrl"
                allow="clipboard-read; clipboard-write">
        </iframe>
    </div>
}

@code {
    private string IframeOrigin;
    private string IframeUrl;

    private User User { get; set; }
    private bool hasLoaded;
    private bool hasAccess;
    private string embedToken;
    private ElementReference iframeRef;

    protected override async Task OnInitializedAsync()
    {
        IframeOrigin = Configuration["AIAnalyticsUrl"]?.TrimEnd('/') ?? throw new InvalidOperationException("AIAnalyticsUrl is not configured.");
        IframeUrl = IframeOrigin + "/";

        User = await m_userService.GetCurrentUserAsync(AuthenticationStateProvider);

        if (Shared.Utils.BlockUsersByAuthStatus(User, null, NavigationManager))
            return;

        hasAccess = User.Roles.Any(r => r.Name == "AI_Analytics" && r.CompanyId == User.CompanyId);

        if (hasAccess)
        {
            var email = AuthUtils.GetEmailFromClaim((await AuthenticationStateProvider.GetAuthenticationStateAsync()).User);
            var isCompanyAdmin = User.Roles.Any(r => r.Name == "Company Admin" && r.CompanyId == User.CompanyId);

            embedToken = EmbedTokenService.GenerateEmbedToken(
                email,
                User.CompanyId,
                hasAccess,
                isCompanyAdmin
            );
        }

        hasLoaded = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && hasAccess && !string.IsNullOrEmpty(embedToken))
        {
            var theme = DarkModeService.IsDarkMode ? "dark" : "light";
            await js.InvokeVoidAsync("AIAnalytics.initEmbedAuth", iframeRef, embedToken, IframeOrigin, theme);
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await js.InvokeVoidAsync("AIAnalytics.dispose");
        }
        catch (JSDisconnectedException)
        {
        }
    }
}