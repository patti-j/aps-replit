@using ReportsWebApp.DB.Models
@inject NavigationManager Navigation

<DxFormLayout>
        @if (!ShowExtraFields)
        {
            @if (AdminUsers != null && AdminUsers.Any())
            {
            <DxFormLayoutItem Caption="Admin User" ColSpanLg="12" CaptionPosition="CaptionPosition.Vertical">
                    <DxComboBox Data="@AdminUsers"
                                TextFieldName="Name"
                                @bind-Value="@SelectedAdminUser" />
                </DxFormLayoutItem>
            }
        <DxFormLayoutItem Caption="New Password" ColSpanLg="12" CaptionPosition="CaptionPosition.Vertical">
                <DxTextBox Password=true
                           NullText="Enter password"
                           @bind-Text="Password" />
            </DxFormLayoutItem>
        }
        else
        {
            <DxFormLayoutItem Caption="Username" ColSpanLg="12" CaptionPosition="CaptionPosition.Vertical">
                <DxTextBox NullText="Enter username"
                           @bind-Text="Username" />
            </DxFormLayoutItem>
        <DxFormLayoutItem Caption="Password" ColSpanLg="12" CaptionPosition="CaptionPosition.Vertical">
                <DxTextBox Password=true
                           NullText="Enter password"
                           @bind-Text="Password" />
            </DxFormLayoutItem>
        }

        <DxFormLayoutItem ColSpanLg="12" Caption="" CaptionPosition="CaptionPosition.Vertical">
            <DxButton CssClass="m-3" RenderStyle="ButtonRenderStyle.Danger" Text="Cancel" Click="@Cancel" />
            @if (!ShowExtraFields)
            {
                <DxButton CssClass="m-3" RenderStyle="ButtonRenderStyle.Secondary" Text="Save" Click="@SaveCredentials" />
            }
            else
            {
                <DxButton CssClass="m-3" RenderStyle="ButtonRenderStyle.Primary" Text="Add App User" Click="@AddAppUser" />
            }
        </DxFormLayoutItem>
</DxFormLayout>

@code {
    [Parameter] public EventCallback Cancel { get; set; }
    [Parameter] public EventCallback<Credentials> ReturnCredentials { get; set; }
    [Parameter] public bool ShowExtraFields { get; set; }
    [Parameter] public string InstanceKey { get; set; }

    public bool ShowLoader { get; set; } = true;
    public List<AdminUser> AdminUsers { get; set; }
    public string SelectedAdminUser { get; set; } = "-1";
    public string Password { get; set; }
    public string Username { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        ShowLoader = true;
        AdminUsers = await GetAdminUsers(InstanceKey);
        SelectedAdminUser = AdminUsers?.FirstOrDefault()?.Id;
        ShowLoader = false;
    }

    private async Task SaveCredentials()
    {
        var credentials = new Credentials
        {
            UserId = SelectedAdminUser,
            Password = Password
        };
        await ReturnCredentials.InvokeAsync(credentials);
    }

    private async Task AddAppUser()
    {
        var credentials = new Credentials
        {
            Username = Username,
            Password = Password
        };
        await ReturnCredentials.InvokeAsync(credentials);
    }

    // Mock method for fetching admin users. Replace with actual implementation.
    private Task<List<AdminUser>> GetAdminUsers(string instanceKey)
    {
        return Task.FromResult(new List<AdminUser>
        {
            new AdminUser { Id = "1", Name = "Admin1" },
            new AdminUser { Id = "2", Name = "Admin2" }
        });
    }
}
